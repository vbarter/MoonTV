# MoonTV 注册功能问题调试指南

当你的 MoonTV 应用在 Cloudflare 上部署后，如果用户注册时遇到"服务器错误"，可以按照以下步骤进行诊断和修复。

## 🔍 快速诊断

### 1. 检查环境变量配置

访问调试端点来检查环境变量配置状态：

```
https://your-domain.com/api/debug/env
```

如果你设置了 `DEBUG_KEY` 环境变量，需要添加 key 参数：

```
https://your-domain.com/api/debug/env?key=你的DEBUG_KEY
```

### 2. 查看 Cloudflare 日志

1. 登录到 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 选择你的网站
3. 进入 **Analytics** > **Logs**
4. 查看实时日志或使用 `wrangler tail` 命令

## 🚨 常见问题及解决方案

### 问题 1: Upstash 环境变量未配置

**错误信息**: "缺少必需的 Upstash 环境变量"

**解决方案**:

1. 确保在 Cloudflare Pages 的环境变量中设置了：

   - `UPSTASH_URL`: 你的 Upstash Redis 端点 URL
   - `UPSTASH_TOKEN`: 你的 Upstash Redis 访问令牌

2. 检查变量名称是否正确（不是 `UPSTASH_REDIS_REST_URL`）

### 问题 2: Upstash 连接失败

**错误信息**: "Upstash Redis 连接失败"

**解决方案**:

1. 验证 Upstash URL 格式正确（应以 `https://` 开头）
2. 确认 Token 有效且有正确的权限
3. 检查 Upstash 实例是否正常运行

### 问题 3: 存储类型配置错误

**错误信息**: "当前模式不支持注册"

**解决方案**:
确保设置了正确的存储类型环境变量：

```
NEXT_PUBLIC_STORAGE_TYPE=upstash
```

### 问题 4: 注册功能未开启

**错误信息**: "当前未开放注册"

**解决方案**:
设置注册开关环境变量：

```
NEXT_PUBLIC_ENABLE_REGISTER=true
```

## 🔧 详细调试步骤

### 第一步：验证环境变量

在 Cloudflare Pages 项目中确认以下环境变量已正确设置：

```bash
# 必需的环境变量
NEXT_PUBLIC_STORAGE_TYPE=upstash
NEXT_PUBLIC_ENABLE_REGISTER=true
UPSTASH_URL=https://your-upstash-endpoint.upstash.io
UPSTASH_TOKEN=your-upstash-token

# 可选的环境变量
USERNAME=admin
PASSWORD=your-admin-password
SITE_NAME=MoonTV
DEBUG_KEY=your-debug-key
```

### 第二步：测试 Upstash 连接

1. 访问调试端点查看 `upstashStatus` 字段
2. 如果显示 `connection_failed`，检查：
   - URL 和 Token 是否正确
   - Upstash 实例是否可访问
   - 网络连接是否正常

### 第三步：查看详细日志

注册过程现在会输出详细的日志信息，包括：

- 环境变量检查结果
- 配置获取状态
- 数据库操作详情
- 错误堆栈信息

通过 Cloudflare 日志或 `wrangler tail` 命令查看这些信息。

### 第四步：手动测试注册流程

使用以下 curl 命令测试注册 API：

```bash
curl -X POST https://your-domain.com/api/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"testpass123"}'
```

## 📊 环境信息说明

调试端点返回的环境信息包括：

```json
{
  "validation": {
    "valid": true/false,
    "errors": ["错误列表"],
    "warnings": ["警告列表"]
  },
  "environment": {
    "storageType": "upstash",
    "enableRegister": true,
    "hasUpstashUrl": true,
    "hasUpstashToken": true,
    "upstashStatus": "connected"
  },
  "cloudflareDetection": {
    "hasCaches": true,
    "cfRayHeader": true
  }
}
```

## 🛠️ 修复建议

基于你的具体情况：

1. **如果是环境变量问题**：

   - 重新检查 Cloudflare Pages 环境变量设置
   - 确保变量名拼写正确
   - 重新部署应用

2. **如果是 Upstash 连接问题**：

   - 验证 Upstash 实例状态
   - 检查访问权限
   - 尝试重新生成 Token

3. **如果是代码问题**：
   - 查看错误堆栈信息
   - 检查是否有语法错误
   - 验证依赖包版本

## 🔄 重新部署

在修改环境变量后，确保重新部署应用：

1. 在 Cloudflare Pages 控制台触发重新部署
2. 或者推送新的代码提交来触发自动部署

## 📞 获取帮助

如果问题仍然存在，请提供：

1. 调试端点的完整输出
2. Cloudflare 日志中的错误信息
3. 你的环境变量配置（隐藏敏感信息）

这些信息将帮助进一步诊断问题。
